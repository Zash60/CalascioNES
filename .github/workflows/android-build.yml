name: Build CalascioNES APK

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
    - name: 1. Checkout do código fonte
      uses: actions/checkout@v4

    - name: 2. Configurar JDK, SDK e NDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    - name: Configurar Android SDK
      uses: android-actions/setup-android@v3
    - name: Configurar Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c

    - name: 3. Preparar Dependências
      run: |
        echo "Limpando arquivos temporários..."
        rm -rf temp_structure SDL2.zip SDL2-devel-*.zip

        echo "Verificando e baixando dependências se necessário..."
        if [ ! -d "imgui" ]; then
          echo "Clonando ImGui..."
          git clone --depth 1 -b docking https://github.com/ocornut/imgui.git
        fi
        
        if [ ! -d "SDL2" ]; then
          echo "Baixando e extraindo SDL2 (versão fonte)..."
          wget https://github.com/libsdl-org/SDL/archive/refs/tags/release-2.30.2.zip -O SDL2.zip
          unzip SDL2.zip
          mv SDL-release-2.30.2 SDL2
        fi

    - name: 4. Criar Estrutura Android e Gerar Arquivos de Build
      run: |
        echo "Criando estrutura de pastas para a compilação..."
        mkdir -p build_dir/app/src/main/cpp
        
        echo "Movendo código fonte e dependências para a estrutura de build..."
        mv src build_dir/app/src/main/cpp/CalascioNES_src
        mv include build_dir/app/src/main/cpp/CalascioNES_include
        mv main.cpp build_dir/app/src/main/cpp/main.cpp
        mv imgui build_dir/app/src/main/cpp/ImGui
        mv SDL2 build_dir/app/src/main/cpp/SDL2

        echo "Gerando AndroidManifest.xml..."
        cat <<EOF > build_dir/app/src/main/AndroidManifest.xml
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android">
            <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" android:maxSdkVersion="28" />
            <application android:label="CalascioNES" android:theme="@android:style/Theme.NoTitleBar.Fullscreen">
                <activity android:name="org.libsdl.app.SDLActivity" android:exported="true" android:screenOrientation="landscape">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" /><category android:name="android.intent.category.LAUNCHER" />
                    </intent-filter>
                </activity>
            </application>
        </manifest>
        EOF

        echo "Gerando settings.gradle..."
        cat <<EOF > build_dir/settings.gradle
        pluginManagement {
            repositories {
                google()
                mavenCentral()
                gradlePluginPortal()
            }
        }
        dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
            repositories {
                google()
                mavenCentral()
            }
        }
        rootProject.name = "CalascioNES"
        include ':app'
        EOF

        echo "Gerando build.gradle (nível do projeto)..."
        cat <<EOF > build_dir/build.gradle
        // Este arquivo está intencionalmente quase vazio para usar a configuração moderna do Gradle.
        plugins {
            id 'com.android.application' version '8.2.0' apply false
        }
        EOF

        echo "Gerando build.gradle (nível do app)..."
        cat <<EOF > build_dir/app/build.gradle
        plugins {
            id 'com.android.application'
        }

        android {
            namespace "com.franco1262.calasciones"
            compileSdk 34

            defaultConfig {
                applicationId "com.franco1262.calasciones"
                minSdk 21
                targetSdk 34
                versionCode 1
                versionName "1.0"
            }

            externalNativeBuild {
                cmake {
                    path "src/main/cpp/CMakeLists.txt"
                    version "3.22.1"
                }
            }
        }
        EOF

        echo "Gerando CMakeLists.txt completo..."
        echo -e 'cmake_minimum_required(VERSION 3.18)\nproject(CalascioNES C CXX)\n\nset(SDL2_SRC_DIR \${CMAKE_CURRENT_SOURCE_DIR}/SDL2)\nadd_library(SDL2 STATIC\n    \${SDL2_SRC_DIR}/src/*.c\n    \${SDL2_SRC_DIR}/src/atomic/*.c\n    \${SDL2_SRC_DIR}/src/audio/*.c\n    \${SDL2_SRC_DIR}/src/core/android/*.c\n    \${SDL2_SRC_DIR}/src/cpuinfo/*.c\n    \${SDL2_SRC_DIR}/src/dynapi/*.c\n    \${SDL2_SRC_DIR}/src/events/*.c\n    \${SDL2_SRC_DIR}/src/file/*.c\n    \${SDL2_SRC_DIR}/src/haptic/*.c\n    \${SDL2_SRC_DIR}/src/joystick/*.c\n    \${SDL2_SRC_DIR}/src/power/*.c\n    \${SDL2_SRC_DIR}/src/render/*.c\n    \${SDL2_SRC_DIR}/src/render/opengl/*.c\n    \${SDL2_SRC_DIR}/src/render/opengles2/*.c\n    \${SDL2_SRC_DIR}/src/stdlib/*.c\n    \${SDL2_SRC_DIR}/src/thread/*.c\n    \${SDL2_SRC_DIR}/src/timer/*.c\n    \${SDL2_SRC_DIR}/src/video/*.c\n    \${SDL2_SRC_DIR}/src/loadso/dlopen/*.c\n    \${SDL2_SRC_DIR}/src/audio/android/*.c\n    \${SDL2_SRC_DIR}/src/joystick/android/*.c\n    \${SDL2_SRC_DIR}/src/haptic/android/*.c\n    \${SDL2_SRC_DIR}/src/power/android/*.c\n    \${SDL2_SRC_DIR}/src/filesystem/android/*.c\n    \${SDL2_SRC_DIR}/src/video/android/*.c\n)\ntarget_include_directories(SDL2 PUBLIC \${SDL2_SRC_DIR}/include)\ntarget_compile_definitions(SDL2 PRIVATE -DUSING_GENERATED_CONFIG_H)\n\nfile(GLOB EMU_SOURCES "\${CMAKE_CURRENT_SOURCE_DIR}/CalascioNES_src/*.cpp" "\${CMAKE_CURRENT_SOURCE_DIR}/main.cpp")\n\nset(IMGUI_DIR \${CMAKE_CURRENT_SOURCE_DIR}/ImGui)\nfile(GLOB IMGUI_SOURCES\n    "\${IMGUI_DIR}/*.cpp"\n    "\${IMGUI_DIR}/backends/imgui_impl_sdl2.cpp"\n    "\${IMGUI_DIR}/backends/imgui_impl_sdlrenderer2.cpp"\n)\n\nadd_library(calasciones SHARED \${EMU_SOURCES} \${IMGUI_SOURCES})\n\ntarget_include_directories(calasciones PUBLIC\n    \${CMAKE_CURRENT_SOURCE_DIR}/CalascioNES_include\n    \${IMGUI_DIR}\n    \${IMGUI_DIR}/backends\n)\n\ntarget_compile_options(calasciones PRIVATE -O3 -flto -march=native -fomit-frame-pointer -funroll-loops -Wall -Wno-unused-variable -Wno-unused-parameter -Wno-narrowing)\n\ntarget_link_libraries(calasciones SDL2 android log GLESv2 OpenSLES)\n' > build_dir/app/src/main/cpp/CMakeLists.txt

    - name: 5. Compilar o APK
      run: |
        cd build_dir
        # Configurar o Gradle Wrapper dentro do diretório de build
        gradle wrapper --gradle-version 8.4
        chmod +x ./gradlew
        # Executar a compilação
        ./gradlew :app:assembleRelease

    - name: 6. Publicar o APK
      uses: actions/upload-artifact@v4
      with:
        name: CalascioNES-Android-APK
        path: build_dir/app/build/outputs/apk/release/app-release-unsigned.apk
